import { GoogleGenerativeAI } from "@google/generative-ai";
import Parser from 'rss-parser';
import admin from 'firebase-admin';

if (!admin.apps.length) {
    admin.initializeApp({
        credential: admin.credential.cert({
            projectId: process.env.FIREBASE_PROJECT_ID,
            clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
            privateKey: process.env.FIREBASE_PRIVATE_KEY ? process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n') : undefined,
        }),
    });
}

const db = admin.firestore();
const appId = "arsenal101-f64ab";

export default async function handler(req, res) {
    try {
        const parser = new Parser();
        const feed = await parser.parseURL('https://news.google.com/rss/search?q=Sport+France+Resultats+Competition&hl=fr&gl=FR&ceid=FR:fr');
        
        const articlesToProcess = feed.items.slice(0, 3);
        const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash", generationConfig: { responseMimeType: "application/json" } });

        const generationPromises = articlesToProcess.map(async (item) => {
            const prompt = `Reporter Sportif Arsenal101. Sujet : "${item.title}". Format JSON { "title": "...", "content": "HTML...", "image_url": "https://source.unsplash.com/featured/?sport,stadium" }`;
            try {
                const result = await model.generateContent(prompt);
                const json = JSON.parse(result.response.text());
                
                // CHEMIN STRICT : artifacts/appId/public/data/articles_sport
                await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data')
                        .collection('articles_sport').add({
                    ...json,
                    date: new Date(),
                    originalLink: item.link
                });
                return json.title;
            } catch (e) { return null; }
        });

        const results = await Promise.all(generationPromises);
        res.status(200).json({ success: true, generated: results });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
}
